import{c as I,r,p as be,j as t,L as me,X as Oe,S as He,C as pe,a as ye,U as We,Z as _e,b as qe,d as Ve,g as Ge}from"./index-DkwX2PFK.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=I("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=I("FileSearch",[["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M4.268 21a2 2 0 0 0 1.727 1H18a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v3",key:"ms7g94"}],["path",{d:"m9 18-1.5-1.5",key:"1j6qii"}],["circle",{cx:"5",cy:"14",r:"3",key:"ufru5t"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=I("Hexagon",[["path",{d:"M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z",key:"yt0hxn"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=I("Palette",[["circle",{cx:"13.5",cy:"6.5",r:".5",fill:"currentColor",key:"1okk4w"}],["circle",{cx:"17.5",cy:"10.5",r:".5",fill:"currentColor",key:"f64h9f"}],["circle",{cx:"8.5",cy:"7.5",r:".5",fill:"currentColor",key:"fotxhn"}],["circle",{cx:"6.5",cy:"12.5",r:".5",fill:"currentColor",key:"qy21gx"}],["path",{d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z",key:"12rzf8"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=I("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);be.GlobalWorkerOptions.workerSrc="//cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";const U=[{name:"Rojo",value:"rgba(239, 68, 68, 0.4)",border:"#ef4444"},{name:"Azul",value:"rgba(59, 130, 246, 0.4)",border:"#3b82f6"},{name:"Verde",value:"rgba(34, 197, 94, 0.4)",border:"#22c55e"},{name:"Amarillo",value:"rgba(234, 179, 8, 0.4)",border:"#eab308"},{name:"Morado",value:"rgba(168, 85, 247, 0.4)",border:"#a855f7"},{name:"Naranja",value:"rgba(249, 115, 22, 0.4)",border:"#f97316"}],J=.3,Q=5,O=.15,ee=15;function ct({pdfUrl:k,repuestoDescripcion:we,existingMarker:d,onSave:te,onCancel:se,repuestos:H=[],onSelectRepuesto:et}){var xe;const P=r.useRef(null),u=r.useRef(null),je=r.useRef(null),[p,ne]=r.useState(null),[w,D]=r.useState((d==null?void 0:d.pagina)||1),[F,ae]=r.useState(0),[j,A]=r.useState(1),[ve,X]=r.useState(!0),[h,W]=r.useState((d==null?void 0:d.forma)||"rectangulo"),[R,Ne]=r.useState((d==null?void 0:d.color)||U[0].value),[M,Se]=r.useState(U[0].border),[oe,Y]=r.useState(!1),[y,$]=r.useState(null),[f,T]=r.useState(null),[l,N]=r.useState((d==null?void 0:d.puntos)||[]),[b,S]=r.useState(!1),[re,Ce]=r.useState(!1),[x,Pe]=r.useState((d==null?void 0:d.sinBorde)===!1),[_,tt]=r.useState(""),[st,le]=r.useState([]),[nt,at]=r.useState(!1),[ot,ce]=r.useState(-1),[E,Re]=r.useState(""),[m,ie]=r.useState([]),[q,he]=r.useState(!1),[B,V]=r.useState(-1),[Me,rt]=r.useState(we);r.useEffect(()=>{if(!k)return;const e=Ge();if(e&&e.url===k){console.log("[PDFMarkerEditor] Usando PDF precargado âš¡"),ne(e.pdf),ae(e.pdf.numPages),X(!1);return}X(!0),be.getDocument(k).promise.then(s=>{ne(s),ae(s.numPages),X(!1)}).catch(s=>{console.error("Error al cargar PDF:",s),X(!1)})},[k]),r.useEffect(()=>{if(!_.trim()||H.length===0){le([]),ce(-1);return}const e=_.toLowerCase(),s=H.filter(a=>{var n,o,c,i;return((n=a.codigoSAP)==null?void 0:n.toLowerCase().includes(e))||((o=a.codigoBaader)==null?void 0:o.toLowerCase().includes(e))||((c=a.textoBreve)==null?void 0:c.toLowerCase().includes(e))||((i=a.descripcion)==null?void 0:i.toLowerCase().includes(e))}).slice(0,10);le(s),ce(s.length>0?0:-1)},[_,H]);const ue=r.useCallback(async e=>{if(!p||!e.trim()){ie([]);return}he(!0);const s=[],a=e.toLowerCase();try{for(let n=1;n<=p.numPages;n++){const i=(await(await p.getPage(n)).getTextContent()).items.filter(g=>"str"in g).map(g=>g.str).join(" ");if(i.toLowerCase().includes(a)){const g=i.toLowerCase().indexOf(a),Z=Math.max(0,g-30),K=Math.min(i.length,g+e.length+30),C="..."+i.substring(Z,K)+"...";s.push({pageNum:n,text:C})}}}catch(n){console.error("Error buscando en PDF:",n)}ie(s),V(s.length>0?0:-1),s.length>0&&D(s[0].pageNum),he(!1)},[p]),Te=()=>{if(m.length===0)return;const e=(B+1)%m.length;V(e),D(m[e].pageNum)},De=()=>{if(m.length===0)return;const e=B===0?m.length-1:B-1;V(e),D(m[e].pageNum)},v=r.useCallback((e,s,a)=>{if(!u.current||e.length===0)return;const n=u.current.getContext("2d");if(n){n.clearRect(0,0,u.current.width,u.current.height),n.beginPath(),n.moveTo(e[0].x,e[0].y);for(let o=1;o<e.length;o++)n.lineTo(e[o].x,e[o].y);a&&!s&&n.lineTo(a.x,a.y),s?(n.closePath(),n.fillStyle=R,n.fill(),x&&(n.strokeStyle=M,n.lineWidth=2,n.stroke())):(n.strokeStyle=M,n.lineWidth=2,n.stroke()),e.forEach((o,c)=>{const i=c===0,g=i&&re&&e.length>2;n.beginPath(),n.arc(o.x,o.y,g?10:6,0,2*Math.PI),i&&e.length>2&&!s?n.fillStyle=g?"#22c55e":"#f97316":n.fillStyle=M,n.fill(),n.fillStyle="white",n.font="bold 10px sans-serif",n.textAlign="center",n.textBaseline="middle",n.fillText(`${c+1}`,o.x,o.y)})}},[R,M,x,re]),L=r.useCallback(e=>{if(!u.current)return;const s=u.current.getContext("2d");if(s){if(s.clearRect(0,0,u.current.width,u.current.height),s.fillStyle=R,h==="rectangulo")s.fillRect(e.x,e.y,e.width,e.height),x&&(s.strokeStyle=M,s.lineWidth=2,s.strokeRect(e.x,e.y,e.width,e.height));else if(h==="circulo"){const a=e.x+e.width/2,n=e.y+e.height/2,o=Math.abs(e.width)/2,c=Math.abs(e.height)/2;s.beginPath(),s.ellipse(a,n,o,c,0,0,2*Math.PI),s.fill(),x&&(s.strokeStyle=M,s.lineWidth=2,s.stroke())}}},[h,R,M,x]),de=r.useCallback(async e=>{if(!p||!P.current)return;const s=await p.getPage(e),a=P.current,n=a.getContext("2d");if(!n)return;const o=s.getViewport({scale:j});a.height=o.height,a.width=o.width,u.current&&(u.current.height=o.height,u.current.width=o.width),await s.render({canvasContext:n,viewport:o}).promise,h==="poligono"&&l.length>0?v(l,b):f&&L(f)},[p,j,f,L,h,l,b,v]);r.useEffect(()=>{de(w)},[w,de]),r.useEffect(()=>{if(!p||!(d!=null&&d.coordenadas)||!P.current)return;(async()=>{const a=(await p.getPage(d.pagina)).getViewport({scale:j}),{x:n,y:o,width:c,height:i}=d.coordenadas,g=n<=1&&o<=1&&c<=1&&i<=1;T(g?{x:n*a.width,y:o*a.height,width:c*a.width,height:i*a.height}:{x:n*j,y:o*j,width:c*j,height:i*j})})()},[p,j,d]);const G=(e,s)=>Math.sqrt(Math.pow(s.x-e.x,2)+Math.pow(s.y-e.y,2)),Ee=e=>{var o;const s=(o=u.current)==null?void 0:o.getBoundingClientRect();if(!s)return;const a=e.clientX-s.left,n=e.clientY-s.top;if(h==="poligono"){if(b){N([{x:a,y:n}]),S(!1);return}if(l.length>2){const i=l[0];if(G({x:a,y:n},i)<ee){S(!0),v(l,!0);return}}const c=[...l,{x:a,y:n}];N(c),v(c,!1)}else Y(!0),$({x:a,y:n}),T(null)},Le=e=>{var o;const s=(o=u.current)==null?void 0:o.getBoundingClientRect();if(!s)return;const a=e.clientX-s.left,n=e.clientY-s.top;if(h==="poligono"&&l.length>0&&!b){const c=l[0],i=l.length>2&&G({x:a,y:n},c)<ee;Ce(i),v(l,!1,{x:a,y:n})}else if(h!=="poligono"&&oe&&y&&u.current){const c={x:Math.min(y.x,a),y:Math.min(y.y,n),width:Math.abs(a-y.x),height:Math.abs(n-y.y)};T(c),L(c)}},ge=()=>{Y(!1),$(null)},Fe=e=>{var c;if(e.touches.length!==1)return;const s=e.touches[0],a=(c=u.current)==null?void 0:c.getBoundingClientRect();if(!a)return;const n=s.clientX-a.left,o=s.clientY-a.top;if(h==="poligono"){if(b){N([{x:n,y:o}]),S(!1);return}if(l.length>2){const g=l[0];if(G({x:n,y:o},g)<ee*1.5){S(!0),v(l,!0);return}}const i=[...l,{x:n,y:o}];N(i),v(i,!1)}else Y(!0),$({x:n,y:o}),T(null)},Be=e=>{if(h==="poligono"||!oe||!y||!u.current||e.touches.length!==1)return;e.preventDefault();const s=e.touches[0],a=u.current.getBoundingClientRect(),n=s.clientX-a.left,o=s.clientY-a.top,c={x:Math.min(y.x,n),y:Math.min(y.y,o),width:Math.abs(n-y.x),height:Math.abs(o-y.y)};T(c),L(c)},Ie=()=>{Y(!1),$(null)},ke=()=>{var e;if(l.length>0){const s=l.slice(0,-1);if(N(s),S(!1),s.length>0)v(s,!1);else{const a=(e=u.current)==null?void 0:e.getContext("2d");a&&u.current&&a.clearRect(0,0,u.current.width,u.current.height)}}},Ae=e=>{e.preventDefault();const s=e.deltaY>0?-O:O;A(a=>Math.min(Q,Math.max(J,a+s)))},z=r.useRef(null),Xe=e=>{if(e.touches.length===2){e.preventDefault();const s=Math.hypot(e.touches[1].clientX-e.touches[0].clientX,e.touches[1].clientY-e.touches[0].clientY);if(z.current!==null){const a=(s-z.current)*.005;A(n=>Math.min(Q,Math.max(J,n+a)))}z.current=s}},Ye=()=>{z.current=null},$e=e=>{Ne(e.value),Se(e.border),f&&setTimeout(()=>L(f),0)},ze=()=>{if(!P.current)return;const e=P.current.width,s=P.current.height;if(h==="poligono"){if(!b||l.length<3)return;const a=l.map(C=>({x:C.x/e,y:C.y/s})),n=l.map(C=>C.x),o=l.map(C=>C.y),c=Math.min(...n),i=Math.min(...o),g=Math.max(...n),Z=Math.max(...o),K={x:c/e,y:i/s,width:(g-c)/e,height:(Z-i)/s};te({pagina:w,coordenadas:K,puntos:a,forma:"poligono",color:R,descripcion:`Marcador en pÃ¡gina ${w}`,sinBorde:!x})}else{if(!f)return;const a={x:f.x/e,y:f.y/s,width:f.width/e,height:f.height/s};te({pagina:w,coordenadas:a,forma:h,color:R,descripcion:`Marcador en pÃ¡gina ${w}`,sinBorde:!x})}},fe=h==="poligono"?b&&l.length>=3:f!==null;return ve?t.jsx("div",{className:"h-full flex items-center justify-center bg-gray-100",children:t.jsx(me,{className:"w-8 h-8 text-primary-600 animate-spin"})}):t.jsxs("div",{className:"h-full flex flex-col bg-gray-800",children:[t.jsxs("div",{className:"px-4 py-2 bg-gray-900 text-white",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("h3",{className:"font-semibold",children:"Marcar en Manual"}),t.jsx("button",{onClick:se,className:"p-1.5 rounded hover:bg-gray-700",children:t.jsx(Oe,{className:"w-5 h-5"})})]}),t.jsxs("div",{className:"flex gap-2 mb-2",children:[t.jsxs("div",{className:"relative flex-1",children:[t.jsx(Ke,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),t.jsx("input",{type:"text",value:E,onChange:e=>Re(e.target.value),onKeyDown:e=>{e.key==="Enter"&&ue(E)},placeholder:"Buscar en PDF (ej: 200.1234, Baader)...",className:"w-full pl-9 pr-3 py-1.5 bg-gray-700 border border-gray-600 rounded-lg text-sm text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"})]}),t.jsx("button",{onClick:()=>ue(E),disabled:q||!E.trim(),className:"px-3 py-1.5 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1",children:q?t.jsx(me,{className:"w-4 h-4 animate-spin"}):t.jsx(He,{className:"w-4 h-4"})})]}),m.length>0&&t.jsx("div",{className:"bg-gray-700 rounded-lg p-2 mb-2",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("span",{className:"text-xs text-gray-300",children:[m.length," resultado(s) - PÃ¡g. ",(xe=m[B])==null?void 0:xe.pageNum]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("button",{onClick:De,className:"p-1 rounded hover:bg-gray-600",children:t.jsx(pe,{className:"w-4 h-4"})}),t.jsxs("span",{className:"text-xs",children:[B+1,"/",m.length]}),t.jsx("button",{onClick:Te,className:"p-1 rounded hover:bg-gray-600",children:t.jsx(ye,{className:"w-4 h-4"})})]})]})}),E&&!q&&m.length===0&&t.jsxs("p",{className:"text-xs text-amber-400 mb-2",children:['No se encontrÃ³ "',E,'" en el PDF']}),t.jsxs("p",{className:"text-xs text-gray-400 truncate",children:[t.jsx("span",{className:"text-primary-400 font-medium",children:"Marcando:"})," ",Me]})]}),t.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-gray-700 text-white flex-wrap gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>D(e=>Math.max(1,e-1)),disabled:w<=1,className:"p-2 rounded hover:bg-gray-600 disabled:opacity-50",children:t.jsx(pe,{className:"w-5 h-5"})}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-sm",children:"PÃ¡g."}),t.jsx("input",{type:"number",value:w,onChange:e=>{const s=parseInt(e.target.value);isNaN(s)||D(Math.min(F,Math.max(1,s)))},className:"w-12 px-2 py-1 bg-gray-600 rounded text-center text-sm focus:outline-none focus:ring-1 focus:ring-primary-500",min:1,max:F}),t.jsxs("span",{className:"text-sm",children:["/ ",F]})]}),t.jsx("button",{onClick:()=>D(e=>Math.min(F,e+1)),disabled:w>=F,className:"p-2 rounded hover:bg-gray-600 disabled:opacity-50",children:t.jsx(ye,{className:"w-5 h-5"})})]}),t.jsxs("div",{className:"flex items-center gap-1 bg-gray-600 rounded p-1",children:[t.jsx("button",{onClick:()=>{W("rectangulo"),N([]),S(!1)},className:`p-2 rounded ${h==="rectangulo"?"bg-primary-600":"hover:bg-gray-500"}`,title:"RectÃ¡ngulo",children:t.jsx(Qe,{className:"w-5 h-5"})}),t.jsx("button",{onClick:()=>{W("circulo"),N([]),S(!1)},className:`p-2 rounded ${h==="circulo"?"bg-primary-600":"hover:bg-gray-500"}`,title:"CÃ­rculo/Elipse",children:t.jsx(Ze,{className:"w-5 h-5"})}),t.jsx("button",{onClick:()=>{W("poligono"),T(null),N([]),S(!1)},className:`p-2 rounded ${h==="poligono"?"bg-primary-600":"hover:bg-gray-500"}`,title:"PolÃ­gono (puntos)",children:t.jsx(Ue,{className:"w-5 h-5"})}),h==="poligono"&&l.length>0&&t.jsx("button",{onClick:ke,className:"p-2 rounded bg-amber-600 hover:bg-amber-500 ml-1",title:"Deshacer Ãºltimo punto",children:t.jsx(We,{className:"w-5 h-5"})})]}),h==="poligono"&&t.jsxs("div",{className:"text-xs text-gray-300 flex items-center gap-2",children:[t.jsxs("span",{className:"bg-gray-600 px-2 py-1 rounded",children:[l.length," punto",l.length!==1?"s":""]}),b&&t.jsx("span",{className:"bg-green-600 px-2 py-1 rounded",children:"âœ“ Cerrado"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Je,{className:"w-4 h-4 mr-1 text-gray-400"}),U.map(e=>t.jsx("button",{onClick:()=>$e(e),className:`w-7 h-7 rounded-full border-2 transition-transform ${R===e.value?"scale-110 border-white":"border-transparent hover:scale-105"}`,style:{backgroundColor:e.border},title:e.name},e.name))]}),t.jsx("button",{onClick:()=>{Pe(!x),h==="poligono"&&l.length>0?setTimeout(()=>v(l,b),0):f&&setTimeout(()=>L(f),0)},className:`px-3 py-1.5 rounded text-xs font-medium transition-colors ${x?"bg-gray-600 text-white hover:bg-gray-500":"bg-primary-600 text-white hover:bg-primary-700"}`,title:x?"Ocultar borde":"Sin borde (solo relleno)",children:x?"â¬œ Con borde":"ðŸŸ¦ Sin borde"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>A(e=>Math.max(J,e-O)),className:"p-2 rounded hover:bg-gray-600",children:t.jsx(_e,{className:"w-5 h-5"})}),t.jsxs("span",{className:"text-sm w-14 text-center",children:[Math.round(j*100),"%"]}),t.jsx("button",{onClick:()=>A(e=>Math.min(Q,e+O)),className:"p-2 rounded hover:bg-gray-600",children:t.jsx(qe,{className:"w-5 h-5"})})]})]}),t.jsxs("div",{className:"px-4 py-2 bg-primary-600 text-white text-sm flex items-center justify-between flex-wrap gap-2",children:[t.jsx("span",{children:h==="poligono"?b?"âœ“ PolÃ­gono cerrado - Listo para guardar":`Haz clic para agregar puntos${l.length>2?" (clic en punto 1 para cerrar)":""}`:`Dibuja un ${h==="rectangulo"?"rectÃ¡ngulo":"cÃ­rculo"} sobre el repuesto`}),t.jsx("span",{className:"text-primary-200 text-xs hidden sm:block",children:"ðŸ’¡ Scroll para zoom"})]}),t.jsx("div",{ref:je,className:"flex-1 overflow-auto flex items-start justify-center p-4",onWheel:Ae,onTouchMove:Xe,onTouchEnd:Ye,children:t.jsxs("div",{className:"relative inline-block",children:[t.jsx("canvas",{ref:P,className:"bg-white shadow-lg"}),t.jsx("canvas",{ref:u,className:"absolute top-0 left-0",style:{cursor:h==="poligono"?"pointer":"crosshair"},onMouseDown:Ee,onMouseMove:Le,onMouseUp:ge,onMouseLeave:ge,onTouchStart:Fe,onTouchMove:Be,onTouchEnd:Ie})]})}),t.jsxs("div",{className:"px-4 py-3 bg-gray-900 flex items-center justify-between flex-wrap gap-2",children:[t.jsx("p",{className:"text-sm text-gray-400",children:fe?"âœ“ Marcador listo - Puedes guardar":h==="poligono"?`Agrega al menos 3 puntos y cierra el polÃ­gono (${l.length} puntos)`:"Dibuja el marcador en el PDF"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:se,className:"px-4 py-2 text-gray-300 hover:text-white transition-colors",children:"Cancelar"}),t.jsxs("button",{onClick:ze,disabled:!fe,className:"flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[t.jsx(Ve,{className:"w-5 h-5"}),"Guardar"]})]})]})]})}export{ct as PDFMarkerEditor};
